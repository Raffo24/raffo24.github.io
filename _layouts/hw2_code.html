<!DOCTYPE html>
<html>
<head>
    <title>Euler Maruyama Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #F7F7F7;
            text-align: center;
        }

        .container {
            width: 80%;
            margin: 40px auto;
            background-color: #FFFFFF;
            padding: 20px;
            border: 1px solid #CCCCCC;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #charts {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .graph {
            width: 45%;
            height: 400px;
            margin: 20px;
        }

        h1,
        h2 {
            color: #333333;
        }

        label {
            font-weight: bold;
            margin-right: 10px;
        }

        input[type="number"] {
            padding: 10px;
            border: 1px solid #CCCCCC;
            border-radius: 5px;
        }

        button {
            background-color: #F2C464;
            font-weight: bold;
            color: #000000;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #E6B655;
        }

        @media (max-width: 800px) {
            .graph {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <h1>Hackers vs Servers Simulation</h1>
    <div class="container">
        <form id="simulationForm" onsubmit="return false;">
            <label for="n">Number of Servers:</label>
            <input type="number" id="n" value="50" min="2" max="500" required><br><br>
            <label for="m">Number of Hackers:</label>
            <input type="number" id="m" value="10" min="1" max="500" required><br><br>
            <label for="p">Breach Probability :</label>
            <input type="number" id="p" value="0.5" step="0.01" min="0" max="1" required><br><br>
            <label for="step">step</label>
            <input type="number" id="step" value="25" min="0" step="1"> <br><br>
            <button id="button" onclick="generateGraphs()">Generate Graphs</button><br><br>
            <label for="randomWalk">randomWalk</label>
            <input type="checkbox" id="randomWalk" checked><br><br>
            <select id="frequencyType">
                <option value="absolute" selected>Absolute Frequency</option>
                <option value="relative">Relative Frequency</option>
            </select>
        </form>
        <div id="charts" style="display: none;">
            <div class="graph">
                <h2>Flat Line Graph</h2>
                <canvas id="flat-line-graph"></canvas>
            </div><br><br>
            <div class="graph">
                <h2>Frequency Distribution at the step x</h2>
                <canvas id="histogramStep"></canvas>
            </div><br><br>
            <div class="graph">
                <br><br>
                <h2>Frequency Distribution at the end</h2>
                <canvas id="histogram"></canvas>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>

            let flatLineChart = null;
            let histogramChart = null;
            let histogramStepchart = null;

            function generateRandomColor() {
                let colore = '#';
                for (let i = 0; i < 6; i++) {
                    colore += '0123456789ABCDEF'[Math.floor(Math.random() * 16)];
                }
                return colore;
            }

            function plotFlatLineChart(servers, hackers, datasets, randomWalk) {
                if (flatLineChart !== null) {
                    flatLineChart.destroy();
                }
                const ctx = document.getElementById('flat-line-graph').getContext('2d');
                let frequencyType = document.getElementById("frequencyType").value;
                

                console.log(datasets)
                if (frequencyType === 'absolute'){
                    datasets.map((dataset) => {
                        dataset.data = dataset.data.map((value, step) => value / step )
                    })
                    console.log(datasets)
                }
                let data = datasets.map(dataset => ({
                    ...dataset,
                    pointRadius: 0,
                }))

                flatLineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: servers,
                        datasets: data,
                    },
                    options: {
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                animation: false,
                                enabled: true,
                                callbacks: {
                                    label: function (context) {
                                        const label = context.dataset.label || '';
                                        return label + ' ==> breached servers: ' + context.raw;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: ['Servers', ""],
                                    font: {
                                        size: 18,
                                    },
                                },
                                min: -1,
                                position: 'bottom',
                                ticks: {
                                    stepSize: 1,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            y: {
                                display: true,
                                beginAtZero: !randomWalk.checked,
                                title: {
                                    display: true,
                                    text: 'Breached Servers',
                                    font: {
                                        size: 18,
                                    },
                                },
                                min: 0,
                                ticks: {
                                    stepSize: 1,
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        },
                        maintainAspectRatio: false
                    }
                });
            }

            function plotHistogram(servers, penetrationCounts, chartId) {
                if (histogramChart !== null) {
                    histogramChart.destroy();
                }

                const chartx = document.getElementById(chartId).getContext('2d');

                histogramChart = new Chart(chartx, {
                    type: 'bar',
                    data: {
                        labels: servers,
                        datasets: [{
                            label: "Number of hackers for each interval of breached servers",
                            backgroundColor: generateRandomColor(),
                            borderWidth: 2,
                            data: penetrationCounts,
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: ['Breached Servers','Inteval closed on the left & open on the right [a,b)'],
                                    font: {
                                        size: 18,
                                    },
                                },
                                ticks: {
                                    font: {
                                    size: 5
                                    }
                                },
                                position: 'bottom'
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Hackers',
                                    font: {
                                        size: 18,
                                    },
                                },
                                ticks: {
                                    stepSize: 1,
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        },
                        maintainAspectRatio: false
                    }
                });
            }
            function getDataset(hackers, servers, p, randomWalk) {
                let dataset = [];
                console.log("randomwalk", randomWalk.checked)
                for (let i = 1; i <= hackers; i++) {
                    let hackerInfo = [];
                    let top = 0;

                    for (let j = 0; j < servers; j++) {
                        let x = top;
                        if (p > Math.random()) { x = ++top; }
                        else if (randomWalk.checked){ x = --top; }
                        hackerInfo.push(x);
                    }

                    dataset.push({
                        data: hackerInfo,
                        label: `Hacker ${i}`,
                        borderColor: generateRandomColor(),
                    });
                }

                return dataset;
            }

            function getDistribution(n, datasets){
                intervalSize = 1;
                if (n >= 10) {
                    intervalSize = 2
                } else if (n >= 20) {
                    intervalSize = 3
                } else if (n >= 50) {
                    intervalSize = 4
                } else if (n >= 100) {
                    intervalSize = 5
                } else if (n >= 200) {
                    intervalSize = 6
                } else if (n >= 300) {
                    intervalSize = 7
                } else if (n >= 400) {
                    intervalSize = 8
                }
                const intervalCount = Math.ceil(n / intervalSize);

                const intervals = Array.from({ length: intervalCount }, (_, i) => `${i * intervalSize}-${(i + 1) * intervalSize}`);
                const distributionCounts = Array(intervalCount).fill(0);
                datasets.forEach(dataset => {
                    const index = Math.floor(dataset.data.at(n-1) / intervalSize);
                    if (index >= 0 && index < intervalCount) { distributionCounts[index]++; }
                });

                while (distributionCounts[0] === 0) {
                    distributionCounts.shift();
                    intervals.shift();
                }
                while (distributionCounts.at(-1) === 0) {
                    distributionCounts.pop();
                    intervals.pop();
                }
                return distributionCounts, intervals;
            }
            function generateGraphs() {
                const n_servers = parseInt(document.getElementById('n').value);
                const n_hackers = parseInt(document.getElementById('m').value);
                const p = parseFloat(document.getElementById('p').value);
                const step = parseInt(document.getElementById('step').value);
                let randomWalk = document.getElementById("randomWalk");
                // Validate input
                if (n_servers < 2 || n_servers > 500 || n_hackers < 1 || n_hackers > 500 || p < 0 || p > 1) {
                    alert('Please enter values in these intervals:\n- 2-500 for servers\n- 1-500 for hackers\n- 0-1 for probability.');
                    return;
                }
                if (step >= n_servers){
                    alert("Please enter value: x_step < n_servers");
                    return;
                }
                const servers = [];
                for (let i = 1; i <= n_servers; i++) { servers.push(i); }

                const hackers = [];
                for (let i = 1; i <= n_hackers; i++) { hackers.push(i); }

                const breachDatasets = getDataset(hackers.length, servers.length, p, randomWalk);

                let distributionCounts, intervals = getDistribution(servers.length, breachDatasets);
                let distributionCountsStep, intervalsStep = getDistribution(step, breachDatasets);
                plotFlatLineChart(servers, hackers, breachDatasets, randomWalk);
                plotHistogram(intervals, distributionCounts, 'histogram');
                plotHistogram(intervalsStep, distributionCountsStep, 'histogramStep');
                document.getElementById('charts').style.display = 'flex';
                // add to document the two values: absolute frequency e relative frequency
                // calcola

            }

        </script>
    </div>
    <div style="text-align: center; margin-top: 20px;">
        <p><a href="/statistics/hw2" style="text-decoration: none; color: #337ab7;">Back to Theory</a></p>
    </div>
</body>

</html>